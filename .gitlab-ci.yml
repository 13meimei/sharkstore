variables:
    PROJECT_DIR: /export/sharkstore/src

before_script:
    - echo ${CI_PROJECT_DIR}
    - gcc --version && go version
    - mkdir -p /export/sharkstore
    - ln -s ${CI_PROJECT_DIR} ${PROJECT_DIR}

stages:
- build
- test
- deploy

build_sharkstore:
  stage: build
  script:
  - echo "build sharkstore data-server....."

  - mkdir -p ${PROJECT_DIR}/data-server/build/
  - cd ${PROJECT_DIR}/data-server/build/ &&
    cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TEST=ON -DBUILD_TOOL=ON &&
    make -j 4

  - echo "build sharkstore master-server"
  - cd ${PROJECT_DIR}/master-server/cmd && go build -o master-server

  - echo "build sharkstore gateway-server"
  - cd ${PROJECT_DIR}/proxy/gateway-server/cmd && go build -o gateway-server

  - echo "done"

test_sharkstore_ds:
  stage: test
  script:
  - echo "run sharkstore test....."

  - cd ${PROJECT_DIR}/data-server/build/test
  - echo $PWD
  - ./range_ddl_unittest
  - ./range_meta_unittest
  - ./range_raw_unittest
  - ./range_sql_unittest
  - ./store_unittest

  - echo "done"

test_sharkstore_gs:
  stage: test
  script:
  - echo "run sharkstore test....."

  - cd ${PROJECT_DIR}/proxy/gateway-server/
  - go test -v -short $(go list ./...)

  - echo "done"

deploy_sharkstore:
  stage: deploy
  script:
  - echo "todo deploy"

